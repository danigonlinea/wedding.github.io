name: PR Agent (Gemini)

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'NÃºmero de PR a revisar manualmente'
        required: false
        type: number
      model:
        description: 'Gemini model to use'
        required: false
        type: choice
        default: 'gemini-3.1-pro-preview'
        options:
          - 'gemini-3.1-pro-preview'
          - 'gemini-3-pro-preview'
          - 'gemini-3-flash-preview'
          - 'gemini-2.5-pro'
          - 'gemini-flash-latest'
          - 'gemini-flash-lite-latest'
          - 'gemini-2.5-flash'
          - 'gemini-2.5-flash-lite'
          - 'gemini-2.0-flash'

  issue_comment:
    types: [created]

jobs:
  pr_agent_job:
    if: ${{ github.event.sender.type != 'Bot' }}
    runs-on: ubuntu-latest

    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Get model (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "GEMINI_MODEL=${{ github.event.inputs.model }}" >> $GITHUB_ENV

      - name: Get model (automatic trigger)
        if: github.event_name == 'pull_request'
        run: |
          echo "GEMINI_MODEL=gemini-3.1-pro-preview" >> $GITHUB_ENV

      - name: Run PR-Agent with Gemini
        uses: qodo-ai/pr-agent@main
        id: pragent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_AI_STUDIO.GEMINI_API_KEY: ${{ secrets.GEM_MODEL_APIK_GH_WORKFLOW }}
          config.model: 'gemini/${{ env.GEMINI_MODEL }}'
          config.fallback_models: '["gemini/gemini-2.5-flash","gemini/gemini-2.0-flash"]'
          config.response_language: 'es'
          github_action_config.auto_review: 'true'
          github_action_config.auto_describe: 'true'
          github_action_config.auto_improve: 'false'
          github_action_config.pr_actions: '["opened","reopened","ready_for_review","synchronize"]'
          github_action_config.allow_issue_comment_commands: 'true'

      - name: Create review summary
        if: always()
        run: |
          mkdir -p review-results
          echo "# PR Agent Review Summary" > review-results/summary.md
          echo "" >> review-results/summary.md
          echo "**Workflow:** PR Agent (Gemini)" >> review-results/summary.md
          echo "**Model:** ${{ env.GEMINI_MODEL }}" >> review-results/summary.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> review-results/summary.md
          echo "**PR Number:** ${{ github.event.pull_request.number || github.event.inputs.pull_request_number }}" >> review-results/summary.md
          echo "**Triggered by:** ${{ github.event_name }}" >> review-results/summary.md
          echo "" >> review-results/summary.md
          echo "## Workflow Details" >> review-results/summary.md
          echo "- Auto Review: Enabled" >> review-results/summary.md
          echo "- Auto Describe: Enabled" >> review-results/summary.md
          echo "- Auto Improve: Disabled" >> review-results/summary.md
          echo "- Response Language: Spanish" >> review-results/summary.md

      - name: Upload review results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-agent-review-${{ github.event.pull_request.number || github.event.inputs.pull_request_number }}-${{ github.run_number }}
          path: review-results/
          retention-days: 30
