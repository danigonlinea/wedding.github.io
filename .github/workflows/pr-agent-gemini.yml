name: PR Agent (Gemini)

on:
  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'Número de PR a revisar manualmente'
        required: true
        type: number
      model:
        description: 'Gemini model to use'
        required: false
        type: choice
        default: 'gemini-3.1-pro-preview'
        options:
          - 'gemini-3.1-pro-preview'
          - 'gemini-3-pro-preview'
          - 'gemini-3-flash-preview'
          - 'gemini-2.5-pro'
          - 'gemini-flash-latest'
          - 'gemini-flash-lite-latest'
          - 'gemini-2.5-flash'
          - 'gemini-2.5-flash-lite'
          - 'gemini-2.0-flash'

jobs:
  pr_agent_job:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set model
        run: |
          echo "GEMINI_MODEL=${{ github.event.inputs.model }}" >> $GITHUB_ENV

      - name: Run PR-Agent with Gemini
        uses: qodo-ai/pr-agent@main
        id: pragent
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI.KEY: ${{ secrets.GEM_MODEL_APIK_GH_WORKFLOW }}
          GOOGLE_AI_STUDIO.GEMINI_API_KEY: ${{ secrets.GEM_MODEL_APIK_GH_WORKFLOW }}
          config.model: 'gemini/${{ env.GEMINI_MODEL }}'
          config.fallback_models: '["gemini/gemini-2.5-flash","gemini/gemini-2.0-flash"]'
          config.language: 'es'
          config.response_language: 'es'
          pr_code_suggestions.commitable_code_suggestions: 'false'
          pr_reviewer.extra_instructions: 'Por favor, proporciona toda la revisión en español. Usa terminología técnica en español cuando sea posible.'
          pr_description.extra_instructions: 'Por favor, escribe la descripción completamente en español.'
          github_action_config.auto_review: 'true'
          github_action_config.auto_describe: 'true'
          github_action_config.auto_improve: 'false'
          github_action_config.pr_actions: '["opened","reopened","ready_for_review","synchronize"]'
          github_action_config.allow_issue_comment_commands: 'true'

      - name: Get PR details and comments
        if: always()
        run: |
          mkdir -p review-results

          # Get PR details
          gh pr view ${{ github.event.inputs.pull_request_number }} --json title,body,comments,reviews > review-results/pr-details.json

          # Get PR comments in markdown format
          gh pr view ${{ github.event.inputs.pull_request_number }} --comments > review-results/pr-comments.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create review summary
        if: always()
        run: |
          echo "# PR Agent Review Summary" > review-results/summary.md
          echo "" >> review-results/summary.md
          echo "**Workflow:** PR Agent (Gemini)" >> review-results/summary.md
          echo "**Model:** ${{ env.GEMINI_MODEL }}" >> review-results/summary.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> review-results/summary.md
          echo "**PR Number:** ${{ github.event.inputs.pull_request_number }}" >> review-results/summary.md
          echo "**Triggered by:** ${{ github.actor }}" >> review-results/summary.md
          echo "**Run ID:** ${{ github.run_id }}" >> review-results/summary.md
          echo "" >> review-results/summary.md
          echo "## Workflow Details" >> review-results/summary.md
          echo "- Auto Review: Enabled" >> review-results/summary.md
          echo "- Auto Describe: Enabled" >> review-results/summary.md
          echo "- Auto Improve: Disabled" >> review-results/summary.md
          echo "- Response Language: Spanish" >> review-results/summary.md
          echo "" >> review-results/summary.md
          echo "## Files Included" >> review-results/summary.md
          echo "- \`summary.md\`: This file with metadata" >> review-results/summary.md
          echo "- \`pr-details.json\`: PR details, comments, and reviews in JSON format" >> review-results/summary.md
          echo "- \`pr-comments.md\`: PR comments in markdown format (includes AI review)" >> review-results/summary.md
          echo "" >> review-results/summary.md
          echo "## How to View the Review" >> review-results/summary.md
          echo "1. Check \`pr-comments.md\` for the AI-generated review comments" >> review-results/summary.md
          echo "2. Or visit the PR directly: https://github.com/${{ github.repository }}/pull/${{ github.event.inputs.pull_request_number }}" >> review-results/summary.md

      - name: Upload review results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-agent-review-${{ github.event.inputs.pull_request_number }}-${{ github.run_number }}.zip
          path: review-results/
          retention-days: 30
          compression-level: 9
