name: PR Agent (Gemini)

on:
  # 1) Automático en PR
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

  # 2) Trigger manual desde Actions
  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'Número de PR a revisar manualmente'
        required: false
        type: number

  # 3) Comandos tipo /review en comentarios
  issue_comment:

jobs:
  pr_agent_job:
    # Evita loops con otros bots
    if: ${{ github.event.sender.type != 'Bot' }}
    runs-on: ubuntu-latest

    permissions:
      issues: write # comentar en issues/PRs
      pull-requests: write # actualizar PRs
      contents: write # leer código del repo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run PR-Agent with Gemini
        uses: qodo-ai/pr-agent@main
        id: pragent
        env:
          # Token automático de GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Tu API key de Google AI Studio (créala como secret GEMINI_API_KEY)
          GOOGLE_AI_STUDIO.GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

          # Modelo Gemini (ajusta si quieres otro)
          config.model: 'gemini/gemini-1.5-flash'
          config.fallback_models: '["gemini/gemini-1.5-flash"]'

          # Idioma de las respuestas del agente
          config.response_language: 'es'

          # Qué hace automáticamente en cada PR
          github_action_config.auto_review: 'true'
          github_action_config.auto_describe: 'true'
          github_action_config.auto_improve: 'false'

          # En qué eventos de PR actúa
          github_action_config.pr_actions: '["opened","reopened","ready_for_review","synchronize"]'

          # Permitir uso con comandos en comentarios (issue_comment)
          github_action_config.allow_issue_comment_commands: 'true'
