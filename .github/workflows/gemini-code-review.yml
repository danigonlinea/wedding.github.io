name: ðŸ¤– Gemini AI Code Review

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request number to review'
        required: true
        type: number
      model:
        description: 'Gemini model to use'
        required: false
        type: choice
        default: 'gemini-3.1-pro-preview'
        options:
          - 'gemini-3.1-pro-preview'
          - 'gemini-3-pro-preview'
          - 'gemini-3-flash-preview'
          - 'gemini-2.5-pro'
          - 'gemini-flash-latest'
          - 'gemini-flash-lite-latest'
          - 'gemini-2.5-flash'
          - 'gemini-2.5-flash-lite'
          - 'gemini-2.0-flash'

  issue_comment:
    types: [created]

jobs:
  gemini-review:
    name: AI Code Review
    if: ${{ github.event.sender.type != 'Bot' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Get PR number and model (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "PR_NUMBER=${{ github.event.inputs.pr_number }}" >> $GITHUB_ENV
          echo "GEMINI_MODEL=${{ github.event.inputs.model }}" >> $GITHUB_ENV

      - name: Get PR number and model (automatic trigger)
        if: github.event_name == 'pull_request'
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "GEMINI_MODEL=gemini-3.1-pro-preview" >> $GITHUB_ENV

      - name: Run PR-Agent Review
        uses: qodo-ai/pr-agent@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_AI_STUDIO.GEMINI_API_KEY: ${{ secrets.GEM_MODEL_APIK_GH_WORKFLOW }}
          config.model: 'gemini/${{ env.GEMINI_MODEL }}'
          config.fallback_models: '["gemini/gemini-2.5-flash","gemini/gemini-2.0-flash"]'
          config.response_language: 'es'
          pr_reviewer.enable_review_labels_effort: 'true'
          pr_reviewer.enable_review_labels_security: 'true'
          pr_reviewer.require_focused_review: 'true'
          pr_reviewer.require_score_review: 'true'
          pr_reviewer.require_tests_review: 'true'
          pr_reviewer.require_security_review: 'true'
          pr_reviewer.require_estimate_effort_to_review: 'true'
          pr_description.publish_labels: 'true'
          pr_description.use_bullet_points: 'true'
          github_action_config.auto_review: 'true'
          github_action_config.auto_describe: 'true'
          github_action_config.auto_improve: 'true'
          github_action_config.allow_issue_comment_commands: 'true'
          github_action_config.pr_actions: '["opened","reopened","ready_for_review","synchronize"]'
          github_action_config.pr_number: ${{ env.PR_NUMBER }}
